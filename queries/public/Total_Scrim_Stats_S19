SELECT
  up."displayName" AS name,
  p.id AS sprocket_player_id,
  gm.code AS gamemode,
  gsgp.description AS skill_group,
  sm."createdAt" AS scrim_created_at,

  COUNT(psl.id) AS rounds_count,

  SUM(
    CASE
      WHEN psl."isHome" = true  AND r."homeWon" = true  THEN 1
      WHEN psl."isHome" = false AND r."homeWon" = false THEN 1
      ELSE 0
    END
  )::float / NULLIF(COUNT(psl.id), 0) AS win_percentage,

  AVG((psl.stats -> 'dpi')::numeric) AS dpi,
  AVG((psl.stats -> 'gpi')::numeric) AS avg_sprocket_rating,
  AVG((psl.stats -> 'opi')::numeric) AS opi,

  SUM(((psl.stats -> 'otherStats' -> 'stats' -> 'core' -> 'score')::numeric)) AS score,
  SUM(((psl.stats -> 'otherStats' -> 'stats' -> 'core' -> 'goals')::numeric)) AS goals,
  SUM(((psl.stats -> 'otherStats' -> 'stats' -> 'core' -> 'assists')::numeric)) AS assists,
  SUM(((psl.stats -> 'otherStats' -> 'stats' -> 'core' -> 'saves')::numeric)) AS saves,
  SUM(((psl.stats -> 'otherStats' -> 'stats' -> 'core' -> 'shots')::numeric)) AS shots,
  SUM(((psl.stats -> 'otherStats' -> 'stats' -> 'core' -> 'goals_against')::numeric)) AS goals_against,
  SUM(((psl.stats -> 'otherStats' -> 'stats' -> 'core' -> 'shots_against')::numeric)) AS shots_against,

  SUM(((psl.stats -> 'otherStats' -> 'stats' -> 'demo' -> 'inflicted')::numeric)) AS demos
FROM sprocket.player_stat_line psl
JOIN sprocket.player p ON psl."playerId" = p.id
JOIN sprocket.round r ON psl."roundId" = r.id
JOIN sprocket.match m ON r."matchId" = m.id
JOIN sprocket.game_mode gm ON m."gameModeId" = gm.id
JOIN sprocket.game_skill_group_profile gsgp ON m."skillGroupId" = gsgp."skillGroupId"
JOIN sprocket.match_parent mp ON mp.id = m."matchParentId"
JOIN sprocket.scrim_meta sm ON mp."scrimMetaId" = sm.id
JOIN sprocket."member" mem ON p."memberId" = mem.id
JOIN sprocket."user" u ON mem."userId" = u.id
JOIN sprocket.user_profile up ON u.id = up."userId"
WHERE sm."createdAt" >= current_date - interval '90 days'
GROUP BY
  up."displayName",
  p.id,
  gm.code,
  gsgp.description,
  sm."createdAt";
